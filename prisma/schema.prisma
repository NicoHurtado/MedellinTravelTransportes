// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum TipoAliado {
  HOTEL
  AIRBNB
}

enum TipoServicio {
  TRANSPORTE_AEROPUERTO
  CITY_TOUR
  TOUR_GUATAPE
  TOUR_PARAPENTE
  TOUR_ATV
  TOUR_HACIENDA_NAPOLES
  TOUR_OCCIDENTE
  TRANSPORTE_POR_HORAS
  OTRO
}

enum EstadoReserva {
  PENDIENTE_COTIZACION
  CONFIRMADA_PENDIENTE_PAGO
  PAGADA_PENDIENTE_ASIGNACION
  CONFIRMADA_PENDIENTE_ASIGNACION  // Nuevo: Para reservas de hotel sin asignar
  ASIGNADA_PENDIENTE_COMPLETAR
  COMPLETADA
  CANCELADA
}

enum EstadoPago {
  PENDIENTE
  APROBADO
  RECHAZADO
  PROCESANDO
}

enum MetodoPago {
  BOLD
  EFECTIVO
}

enum Idioma {
  ES
  EN
}

enum Municipio {
  MEDELLIN
  POBLADO
  LAURELES
  SABANETA
  BELLO
  ITAGUI
  ENVIGADO
  OTRO
}

enum TipoDocumento {
  CC
  PASAPORTE
  TI
  CE
}

enum TipoAdicional {
  FIJO
  POR_PERSONA
  POR_CANTIDAD
}

enum TipoCampo {
  TEXT
  SELECT
  SWITCH
  COUNTER
  TEXTAREA
}

enum AeropuertoTipo {
  DESDE
  HACIA
}

enum AeropuertoNombre {
  JOSE_MARIA_CORDOVA
  OLAYA_HERRERA
}

// ============================================
// MODELS
// ============================================

// Admin User
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Aliados (Hoteles y Airbnbs)
model Aliado {
  id        String     @id @default(cuid())
  nombre    String
  tipo      TipoAliado
  codigo    String     @unique // 6 d√≠gitos auto-generado
  email     String
  contacto  String
  activo    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relaciones
  reservas          Reserva[]
  tarifas           TarifaAliado[]
  serviciosAliado   ServicioAliado[]
  tarifasMunicipios TarifaMunicipioAliado[]

  @@index([codigo])
}

// Servicios (Tours, Transporte, etc.)
model Servicio {
  id String @id @default(cuid())

  // üåç Multi-language fields (JSONB format: {"es": "...", "en": "..."})
  nombre      Json // {"es": "Tour Guatap√©", "en": "Guatap√© Tour"}
  descripcion Json // {"es": "Tour completo...", "en": "Complete tour..."}
  incluye     Json // {"es": ["Transporte", "Gu√≠a"], "en": ["Transport", "Guide"]}

  tipo       TipoServicio
  imagen     String // URL
  activo     Boolean      @default(true)
  duracion   String? // ej: "8 horas"
  precioBase Decimal      @db.Decimal(10, 2)

  // Recargo Nocturno
  aplicaRecargoNocturno Boolean  @default(false)
  recargoNocturnoInicio String? // HH:mm
  recargoNocturnoFin    String? // HH:mm
  montoRecargoNocturno  Decimal? @db.Decimal(10, 2)

  // üî• CRITICAL: Special Service Logic Flags (Zero Hardcoding)
  esAeropuerto    Boolean @default(false) // Shows airport buttons UI in wizard
  esPorHoras      Boolean @default(false) // Habilita flujo especial de WhatsApp
  destinoAutoFill String? // If set, auto-fills destination field (e.g., "Guatap√©")

  // üî• CRITICAL: Dynamic Fields Configuration (JSONB Approach)
  // Array de objetos que define campos personalizados
  // Estructura validada con Zod en runtime
  // Ejemplo: [{ "clave": "numeroVuelo", "etiqueta": { "es": "N√∫mero de Vuelo", "en": "Flight Number" }, "tipo": "TEXT", "requerido": true, "orden": 1 }]
  camposPersonalizados Json @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones (sin cambios)
  adicionales         ServicioAdicional[]
  vehiculosPermitidos ServicioVehiculo[]
  reservas            Reserva[]
  tarifasAliados      TarifaAliado[]
  tarifasMunicipios   TarifaMunicipioServicio[]
  calificaciones      Calificacion[]
  serviciosAliado     ServicioAliado[]
}

// Vehiculos
model Vehiculo {
  id              String   @id @default(cuid())
  nombre          String // ej: "Van 7 pasajeros"
  capacidadMinima Int
  capacidadMaxima Int
  imagen          String // URL PNG
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  servicios      ServicioVehiculo[]
  reservas       Reserva[]
  preciosAliados PrecioVehiculoAliado[]
}

// Tabla intermedia Servicio-Vehiculo con precios
model ServicioVehiculo {
  id         String  @id @default(cuid())
  servicioId String
  vehiculoId String
  precio     Decimal @db.Decimal(10, 2)

  servicio Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  vehiculo Vehiculo @relation(fields: [vehiculoId], references: [id], onDelete: Cascade)

  @@unique([servicioId, vehiculoId])
}

// Conductores
model Conductor {
  id            String   @id @default(cuid())
  nombre        String
  whatsapp      String
  telefono      String   // N√∫mero de tel√©fono
  documento     String   // N√∫mero de documento/c√©dula
  placa         String   // Placa del veh√≠culo
  foto          String?  // URL de la foto (Vercel Blob) - opcional
  disponible    Boolean  @default(true)
  activo        Boolean  @default(true)
  fotosVehiculo String[] // URLs
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  reservas Reserva[]
}

// ‚≠ê RESERVAS - Modelo m√°s importante
model Reserva {
  id     String @id @default(cuid())
  codigo String @unique // ej: "RES8X3K2"

  // Informaci√≥n del Cliente
  nombreCliente   String
  whatsappCliente String
  emailCliente    String

  // Detalles del Servicio
  servicioId      String
  fecha           DateTime
  hora            String
  idioma          Idioma
  municipio       Municipio
  otroMunicipio   String? // si municipio = OTRO
  numeroPasajeros Int
  vehiculoId      String?

  // Campos Espec√≠ficos por Tipo de Servicio
  aeropuertoTipo        AeropuertoTipo?
  aeropuertoNombre      AeropuertoNombre?
  numeroVuelo           String?
  lugarRecogida         String?
  guiaCertificado       Boolean           @default(false)
  vueltaBote            Boolean           @default(false)
  cantidadAlmuerzos     Int               @default(0)
  cantidadMotos         Int               @default(0)
  cantidadParticipantes Int               @default(0)

  // Precios y Pagos
  precioBase        Decimal  @db.Decimal(10, 2)
  precioAdicionales Decimal  @default(0) @db.Decimal(10, 2)
  recargoNocturno   Decimal  @default(0) @db.Decimal(10, 2)
  tarifaMunicipio   Decimal  @default(0) @db.Decimal(10, 2)
  descuentoAliado   Decimal  @default(0) @db.Decimal(10, 2)
  precioTotal       Decimal  @db.Decimal(10, 2)
  comisionBold      Decimal? @db.Decimal(10, 2)
  comisionAliado    Decimal? @db.Decimal(10, 2)

  // Estado y Asignaci√≥n
  estado              EstadoReserva
  estadoPago          EstadoPago?
  conductorId         String?
  conductorAsignadoAt DateTime?

  // Aliado (si es reserva de hotel/airbnb)
  aliadoId        String?
  esReservaAliado Boolean @default(false)

  // M√©todo de Pago
  metodoPago MetodoPago @default(BOLD)

  // Notas y Metadata
  notas         String? @db.Text // del cliente
  notasInternas String? @db.Text // solo admin
  hashPago      String? // Bold hash
  pagoId        String? // transaction ID Bold

  // Campos din√°micos del formulario (JSON)
  // Guarda las respuestas del cliente a los campos personalizados del servicio
  // Ejemplo: { "numeroVuelo": "AV123", "vueltaBote": true, "cantidadAlmuerzos": 2 }
  datosDinamicos Json? @default("{}")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  canceladaAt DateTime?

  // Relaciones
  servicio                 Servicio           @relation(fields: [servicioId], references: [id])
  vehiculo                 Vehiculo?          @relation(fields: [vehiculoId], references: [id])
  conductor                Conductor?         @relation(fields: [conductorId], references: [id])
  aliado                   Aliado?            @relation(fields: [aliadoId], references: [id])
  asistentes               Asistente[]
  adicionalesSeleccionados ReservaAdicional[]
  calificacion             Calificacion?

  @@index([codigo])
  @@index([estado])
  @@index([fecha])
  @@index([servicioId])
  @@index([aliadoId])
}

// Asistentes (personas en la reserva)
model Asistente {
  id              String        @id @default(cuid())
  reservaId       String
  nombre          String
  tipoDocumento   TipoDocumento
  numeroDocumento String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  reserva Reserva @relation(fields: [reservaId], references: [id], onDelete: Cascade)
}

// Servicios Adicionales (gu√≠a, almuerzo, bote, etc)
model ServicioAdicional {
  id         String        @id @default(cuid())
  servicioId String
  nombre     String // ej: "Gu√≠a certificado"
  precio     Decimal       @db.Decimal(10, 2)
  tipo       TipoAdicional
  activo     Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  servicio Servicio           @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  reservas ReservaAdicional[]
}

// Tabla intermedia Reserva-Adicional
model ReservaAdicional {
  id             String  @id @default(cuid())
  reservaId      String
  adicionalId    String
  cantidad       Int     @default(1)
  precioUnitario Decimal @db.Decimal(10, 2)
  precioTotal    Decimal @db.Decimal(10, 2)

  reserva   Reserva           @relation(fields: [reservaId], references: [id], onDelete: Cascade)
  adicional ServicioAdicional @relation(fields: [adicionalId], references: [id], onDelete: Cascade)

  @@unique([reservaId, adicionalId])
}

// Tarifas Especiales por Aliado
model TarifaAliado {
  id                 String   @id @default(cuid())
  aliadoId           String
  servicioId         String
  precioEspecial     Decimal? @db.Decimal(10, 2)
  comisionPorcentaje Decimal  @db.Decimal(5, 2) // ej: 15.00 = 15%
  descuentoEspecial  Decimal  @default(0) @db.Decimal(10, 2)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  aliado   Aliado   @relation(fields: [aliadoId], references: [id], onDelete: Cascade)
  servicio Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@unique([aliadoId, servicioId])
}

// Calificaciones (Reviews 1-5 estrellas)
model Calificacion {
  id            String   @id @default(cuid())
  reservaId     String   @unique
  servicioId    String
  estrellas     Int // 1-5
  comentario    String?  @db.Text
  nombreCliente String
  esPublica     Boolean  @default(false)
  destacada     Boolean  @default(false) // Featured on landing page
  ordenDestacada Int?    // Order for featured reviews (1, 2, 3)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  reserva  Reserva  @relation(fields: [reservaId], references: [id], onDelete: Cascade)
  servicio Servicio @relation(fields: [servicioId], references: [id])

  @@index([esPublica])
  @@index([createdAt])
  @@index([destacada])
}

// ============================================
// SISTEMA DE PRECIOS PERSONALIZADOS POR ALIADO
// ============================================

// Relaci√≥n Servicio-Aliado con configuraci√≥n de precios
// Relaci√≥n Servicio-Aliado con configuraci√≥n de precios
model ServicioAliado {
  id         String  @id @default(cuid())
  aliadoId   String
  servicioId String
  activo     Boolean @default(true)

  aliado           Aliado                 @relation(fields: [aliadoId], references: [id], onDelete: Cascade)
  servicio         Servicio               @relation(fields: [servicioId], references: [id], onDelete: Cascade)
  preciosVehiculos PrecioVehiculoAliado[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([aliadoId, servicioId])
  @@index([aliadoId])
  @@index([servicioId])
}

// Precios personalizados de veh√≠culos por aliado
model PrecioVehiculoAliado {
  id               String  @id @default(cuid())
  servicioAliadoId String
  vehiculoId       String
  precio           Decimal @db.Decimal(10, 2)
  comision         Decimal @default(0) @db.Decimal(10, 2)

  servicioAliado ServicioAliado @relation(fields: [servicioAliadoId], references: [id], onDelete: Cascade)
  vehiculo       Vehiculo       @relation(fields: [vehiculoId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([servicioAliadoId, vehiculoId])
  @@index([servicioAliadoId])
  @@index([vehiculoId])
}

// Tarifas adicionales por municipio para cada aliado
model TarifaMunicipioAliado {
  id         String    @id @default(cuid())
  aliadoId   String
  municipio  Municipio
  valorExtra Decimal   @db.Decimal(10, 2)

  aliado Aliado @relation(fields: [aliadoId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([aliadoId, municipio])
  @@index([aliadoId])
}

// Base de Datos Antigua (hist√≥rico - solo lectura)
model BdAntigua {
  id                    Int       @id @default(autoincrement())
  hora_reserva          DateTime?
  canal                 String?
  nombre                String?
  idioma                String?
  fecha                 DateTime? @db.Date
  hora                  DateTime? @db.Time
  servicio              String?
  vehiculo              String?
  numero_vuelo          String?
  numero_contacto       String?
  cotizacion            String?
  comision              String?
  informacion_adicional String?
  estado_servicio       String?
  estado_pago           String?
  conductor             String?
  created_at            DateTime  @default(now())

  @@map("bd_antigua")
}

// Tarifas por Municipio para Servicios
// Permite configurar precios adicionales por municipio para cada servicio
// Se aplican solo a usuarios regulares (sin c√≥digo de aliado)
model TarifaMunicipioServicio {
  id         String    @id @default(cuid())
  servicioId String
  municipio  Municipio
  valorExtra Decimal   @default(0) @db.Decimal(10, 2)

  servicio Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)

  @@unique([servicioId, municipio])
  @@map("tarifas_municipio_servicio")
}
